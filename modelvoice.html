<div style="text-align: center; margin: 20px 0; font-size: 24px;">Teachable Machine Audio Model</div>
<div style="text-align: center; margin-top: 20px 0;">
  <button type="button" onclick="init()" style="padding: 15px 40px; font-size: 20px; border-radius: 8px; cursor: pointer;">Start</button>
</div>
<div id="label-container" style="text-align: center; margin-top: 30px;font-size: 20px"></div>


<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>

<script type="text/javascript">
    const URL = "https://4b445eb1-bbb8-4654-95e5-33006767e0ad-00-mk3p9a1e64us.pike.replit.dev/my_model/";

    const musicFighting = new Audio("fighting.mp3");
    const musicHappy = new Audio("Live My Life.mp3");

    async function createModel() {
        const checkpointURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        const recognizer = speechCommands.create(
            "BROWSER_FFT",
            undefined,
            checkpointURL,
            metadataURL
        );

        await recognizer.ensureModelLoaded();
        return recognizer;
    }

    async function init() {
        console.log("âœ… init å‡½å¼æœ‰è¢«å‘¼å«");

        // å˜—è©¦é å…ˆéœéŸ³æ’­æ”¾ï¼Œå–å¾—ç€è¦½å™¨æ’­æ”¾æ¬Šé™
        await Promise.all([musicFighting, musicHappy].map(async (audio) => {
            audio.muted = true;
            try {
                await audio.play();
            } catch (e) {
                console.warn("âš ï¸ æ’­æ”¾æ¬Šé™åˆå§‹åŒ–å¤±æ•—ï¼š", e);
            }
            audio.pause();
            audio.currentTime = 0;
            audio.muted = false;
        }));

        const recognizer = await createModel();
        const classLabels = recognizer.wordLabels();
        const labelContainer = document.getElementById("label-container");
        labelContainer.innerHTML = "";

        for (let i = 0; i < classLabels.length; i++) {
            labelContainer.appendChild(document.createElement("div"));
        }

        recognizer.listen(result => {
            const scores = result.scores;

            for (let i = 0; i < classLabels.length; i++) {
                labelContainer.childNodes[i].innerHTML = classLabels[i] + ": " + scores[i].toFixed(2);
            }

            const tiredIndex = classLabels.indexOf("å˜†æ°£/ç–²å‹ğŸ˜©");
            const happyIndex = classLabels.indexOf("é–‹å¿ƒğŸ˜Š");

            if (tiredIndex !== -1 && scores[tiredIndex] > 0.90) {
                if (musicHappy && !musicHappy.paused) musicHappy.pause();
                if (musicFighting.paused) {
                    musicFighting.currentTime = 0;
                    musicFighting.play();
                }
            }

            if (happyIndex !== -1 && scores[happyIndex] > 0.90) {
                if (musicFighting && !musicFighting.paused) musicFighting.pause();
                if (musicHappy.paused) {
                    musicHappy.currentTime = 0;
                    musicHappy.play();
                }
            }

        }, {
            includeSpectrogram: true,
            probabilityThreshold: 0.75,
            invokeCallbackOnNoiseAndUnknown: true,
            overlapFactor: 0.50
        });
    }
</script>
